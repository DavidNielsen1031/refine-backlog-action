name: Test Action

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  validate:
    name: Validate structure
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Run validation
        run: bash __tests__/validate-action.sh

  integration:
    name: Integration test
    runs-on: ubuntu-latest
    if: ${{ secrets.REFINE_BACKLOG_KEY != '' }}
    steps:
      - uses: actions/checkout@v4
      - name: Refine test items
        id: refine
        uses: ./
        with:
          items: "Fix login bug\nAdd export to CSV\nImprove error messages"
          gherkin: "true"
          key: ${{ secrets.REFINE_BACKLOG_KEY }}
      - name: Verify output
        run: |
          COUNT="${{ steps.refine.outputs.count }}"
          [ "$COUNT" -ge "1" ] && echo "✅ $COUNT items refined" || (echo "❌ Expected ≥1 items"; exit 1)
